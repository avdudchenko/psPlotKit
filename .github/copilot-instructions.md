# psPlotKit — Copilot Instructions

## Project Overview

psPlotKit is a Python plotting/analysis toolkit for data generated by the **Parameter Sweep (PS) tool** and **Loop tool** — primarily HDF5 (`.h5`) and JSON files produced by WaterTAP/IDAES process simulations. It imports hierarchical simulation results, manages unit conversions, computes levelized costs, and produces publication-quality matplotlib figures.

## Architecture — Two-Layer Pipeline

```
data_manager/          →  data_plotter/
  PsDataImport             FigureGenerator  (low-level matplotlib wrapper)
  PsData                   linePlotter, boxPlotter, BreakDownPlotter, MapPlotter
  PsDataManager (dict)     (each plotter consumes a PsDataManager)
  PsCosting
```

1. **`PsDataImport`** — reads `.h5` / `.json`, auto-discovers directories (parameter sweep runs), indexes data keys, and produces `PsData` objects.
2. **`PsData`** — wraps a numpy array with physical units (via the `quantities` library), supports unit conversion (`to_units`), unit assignment (`assign_units`), feasibility masking, and label generation for matplotlib.
3. **`PsDataManager(dict)`** — central data store. Keys are `(directory_tuple, data_key)` tuples. Provides `load_data`, `register_data_key`, `reduce_data` (stacking/min-reduction across sweep axes), `normalize_data`, `eval_function`, `get_costing`, and data selection helpers.
4. **`PsCosting`** — computes CAPEX/OPEX breakdowns and levelized costs per device group from costing blocks in the simulation data.
5. **Plotters** (`linePlotter`, `BreakDownPlotter`, `boxPlotter`, `MapPlotter`) — high-level plotting classes that accept a `PsDataManager`, select data, and delegate rendering to `FigureGenerator`.
6. **`FigureGenerator`** — thin matplotlib wrapper providing `plot_line`, `plot_bar`, `plot_map`, `plot_area`, axis styling, colorbars, and figure save/show.

## Key Conventions

### Naming & Deprecation Pattern
Every class has a **PascalCase canonical name** and a **legacy camelCase/lowercase subclass alias** that logs a deprecation warning. Always use the canonical names:
- `PsData` (not `psData`), `PsDataManager` (not `psDataManager`)
- `FigureGenerator` (not `figureGenerator`), `BreakDownPlotter` (not `breakDownPlotter`)

### Data Key Dictionaries
When specifying data to import, keys are passed as dicts with specific fields:
```python
{"filekey": "fs.costing.LCOW", "return_key": "LCOW", "units": "USD/m**3"}
# Optional fields: "assign_units", "conversion_factor", "directories"
```

### Unit Handling
Units flow through `quantities` (aliased as `qs`). Custom units (`USD`, `PPM`) are registered in `CustomUnits`. String unit normalization happens in `PsData._convert_string_unit` (e.g., `"gal"` → `"US_liquid_gallon"`, `"°C"` → `"*degC"`, `"USD/a"` → `"USD/year"`).

### Logging
Every module creates its logger via `psPlotKit.util.logger.define_logger(__name__, "DisplayName")`. Use this pattern — do not use `logging.getLogger` directly.

### Composite Tuple Keys
`PsDataManager` stores data under composite tuple keys built from directory labels and data keys (e.g., `(("erd_type", "pressure_exchanger"), "membrane_cost", "LCOW")`). The `add_data(dir_key, data_key, PsData)` method constructs these automatically.

## Development Setup

```bash
conda env create -f psplotkit.yml   # Python 3.11, pytest, editable install
conda activate psPlotKit
```

Dependencies: `h5py`, `quantities`, `matplotlib`, `numpy`, `scipy`, `sigfig`, `pyyaml`.

## Testing

```bash
pytest src/psPlotKit/data_manager/tests/
```

Tests live alongside the modules they cover (e.g., `data_manager/tests/`). Test fixtures load `.h5` files from the same test directory using `os.path.dirname(os.path.abspath(__file__))`.

## File Layout

- `src/psPlotKit/data_manager/` — data import, storage, costing logic
- `src/psPlotKit/data_plotter/` — all plotting classes and figure generation
- `src/psPlotKit/util/` — shared logger and filesystem helpers
- `src/psPlotKit/examples/` — runnable example scripts with sample data in `examples/data/`
- `legacy_data_collator.py` — legacy monolithic class; do not extend, prefer the modular pipeline above
